<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR Debug</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs gps-camera="minAccuracy: 20">
        <a-text id="gps-text" value="Getting GPS..." position="0 3 -5" color="white"></a-text>
        <a-text value="GPS is working!" position="0 2 -5"></a-text>

        <!-- Flashing Green Dots (Guide to Target Location) -->
        <a-entity 
            id="guidanceDots"
            geometry="primitive: sphere; radius: 1" 
            material="color: green; opacity: 1"
            visible="false"
            animation="property: material.opacity; from: 1; to: 0.2; dir: alternate; dur: 500; loop: true">
        </a-entity>

        <!-- "Box Here" Text (Hidden Initially) -->
        <a-text 
            id="boxText"
            value="Box Here" 
            position="0 2 -5" 
            visible="false"
            color="white">
        </a-text>

        <!-- Target Box (Hidden Initially) -->
        <a-entity 
            id="targetBox"
            gps-entity-place="latitude: 33.873717; longitude: 35.521254" 
            geometry="primitive: box" 
            material="color: red"
            scale="1 1 1"
            position="0 1 0" 
            visible="false">
        </a-entity>

        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        // Function to Get Distance and Direction Between User & Target
        function getDirection(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // Distance in meters

            const angle = Math.atan2(lon2 - lon1, lat2 - lat1) * (180 / Math.PI); // Direction in degrees

            return { distance, angle };
        }

        // Function to Show Green Dot in the Correct Screen Position (Top, Left, Right, Bottom)
        function updateGreenDotPosition(angle) {
            const dot = document.querySelector("#guidanceDots");

            // If angle between -45 and 45 -> User needs to go forward (Top of the screen)
            if (angle >= -45 && angle <= 45) {
                dot.setAttribute("position", "0 1 -5"); // Top
                dot.setAttribute("visible", "true");
            }
            // If angle between 45 and 135 -> User needs to go right (Right side of the screen)
            else if (angle > 45 && angle <= 135) {
                dot.setAttribute("position", "2 0 -5"); // Right
                dot.setAttribute("visible", "true");
            }
            // If angle between -135 and -45 -> User needs to go left (Left side of the screen)
            else if (angle >= -135 && angle < -45) {
                dot.setAttribute("position", "-2 0 -5"); // Left
                dot.setAttribute("visible", "true");
            }
            // If angle between 135 and 180 or -180 and -135 -> User needs to go backwards (Bottom of the screen)
            else {
                dot.setAttribute("position", "0 -1 -5"); // Bottom
                dot.setAttribute("visible", "true");
            }
        }

        // Function to Update GPS Location & Green Dot Direction
        function checkDistanceAndDirection() {
            navigator.geolocation.getCurrentPosition((position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                const targetLat = 33.873717; // Target Latitude
                const targetLon = 35.521254; // Target Longitude

                const { angle } = getDirection(userLat, userLon, targetLat, targetLon);
                console.log("Direction angle:", angle);

                // Show the correct green dot location based on direction
                updateGreenDotPosition(angle);
            });
        }

        // Continuously Check User's Location and Direction
        setInterval(checkDistanceAndDirection, 1000);

        // Function to Update User's GPS Position (Display text)
        function updateUI() {
            let camera = document.querySelector("[gps-camera]");
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        let lat = position.coords.latitude.toFixed(6);
                        let lon = position.coords.longitude.toFixed(6);
                        console.log("User location:", lat, lon);

                        // Update on-screen GPS text
                        document.getElementById("gps-text").setAttribute("value", `Lat: ${lat}, Lon: ${lon}`);
                    },
                    (error) => {
                        console.error("Error getting location:", error);
                        alert("Please enable GPS to see the AR model.");
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Start GPS Tracking
        updateUI();
    </script>
</body>
</html>
