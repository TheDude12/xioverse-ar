<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR Debug</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs gps-camera="minAccuracy: 20">
        <a-text id="gps-text" value="Getting GPS..." position="0 3 -5" color="white"></a-text>
        <a-text value="GPS is working!" position="0 2 -5"></a-text>

           <!-- Flashing Green Dots (Guide to Target Location) -->
        <a-entity 
            id="guidanceDots"
            gps-entity-place="latitude: 33.873717; longitude: 35.521254"
            geometry="primitive: sphere; radius: 0.2" 
            material="color: green; opacity: 0.8"
            animation="property: material.opacity; from: 0; to: 1; dir: alternate; dur: 500; loop: true">
        </a-entity>

        <!-- "Box Here" Text (Hidden Initially) -->
        <a-text 
            id="boxText"
            value="Box Here" 
            position="0 2 -5" 
            visible="false"
            color="white">
        </a-text>

        <!-- Target Box (Hidden Initially) -->
        <a-entity 
            id="targetBox"
            gps-entity-place="latitude: 33.873717; longitude: 35.521254" 
            geometry="primitive: box" 
            material="color: red"
            scale="1 1 1"
            position="0 1 0" 
            visible="false">
        </a-entity>

        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        // Function to Get Distance Between User & Target
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        // Function to Check Distance and Update Visibility
        function checkDistance() {
            navigator.geolocation.getCurrentPosition((position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                const targetLat = 33.873717;
                const targetLon = 35.521254;

                const distance = getDistance(userLat, userLon, targetLat, targetLon);
                console.log("Distance to box:", distance, "meters");

                const dots = document.querySelector("#guidanceDots");
                const boxText = document.querySelector("#boxText");
                const box = document.querySelector("#targetBox");

                if (distance < 3) {
                    dots.setAttribute("visible", "false");
                    boxText.setAttribute("visible", "true");
                    box.setAttribute("visible", "true");
                } else {
                    dots.setAttribute("visible", "true");
                    boxText.setAttribute("visible", "false");
                    box.setAttribute("visible", "false");
                }
            });
        }

        // Continuously Update User GPS Location & Box Height
        function updateUI() {
            let camera = document.querySelector("[gps-camera]");
            let box = document.getElementById("targetBox");

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        let lat = position.coords.latitude.toFixed(6);
                        let lon = position.coords.longitude.toFixed(6);
                        console.log("User location:", lat, lon);

                        // Update on-screen GPS text
                        document.getElementById("gps-text").setAttribute("value", `Lat: ${lat}, Lon: ${lon}`);

                        // Adjust box height to match camera height
                        if (camera && box) {
                            let cameraHeight = camera.object3D.position.y || 1.6; // Default height if not detected
                            box.setAttribute("position", `0 ${cameraHeight} 0`);
                        }
                    },
                    (error) => {
                        console.error("Error getting location:", error);
                        alert("Please enable GPS to see the AR model.");
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Start GPS Tracking and Box Height Adjustment
        updateUI();

        // Run Distance Check Every Second
        setInterval(checkDistance, 1000);
    </script>

</body>
</html>
